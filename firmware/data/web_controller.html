<!DOCTYPE HTML>
<html>
<head>
  <style>
    .title {
      text-align: center;
      position: relative;
    }
    .lang-switch, .settings-btn, .planner-btn {
      background-color: #1E90FF;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px #999;
      transition: all 0.3s;
    }
    .header-actions-left {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .header-actions-right {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .planner-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .lang-switch:hover, .settings-btn:hover {
      background-color: #0b7dda;
    }
    .planner-btn:hover { background-color: #0b7dda; }
    .lang-switch:active, .settings-btn:active {
      box-shadow: 0 2px #666;
      transform: translateY(-48%);
    }
    .planner-btn:active {
      box-shadow: 0 2px #666;
      transform: translateY(-48%);
    }
    .button { 
      display: inline-block;
      width: 130px; /* æ‰€æœ‰æŒ‰é’®çš„ç»Ÿä¸€å®½åº¦ */
      height: 50px; /* æ‰€æœ‰æŒ‰é’®çš„ç»Ÿä¸€é«˜åº¦ */
      line-height: 50px; /* ä½¿æ–‡æœ¬å‚ç›´å±…ä¸­ */
      font-size: 20px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      outline: none;
      color: #fff;
      background-color: #1E90FF;
      border: none;
      border-radius: 10px;
      box-shadow: 0 9px #999;
    }
    .button:hover {background-color: #0b7dda}
    .button:active {
      background-color: #0b7dda;
      box-shadow: 0 5px #666;
      transform: translateY(4px);
    }

    /* ç§»åŠ¨æŒ‰é’®çš„é¢œè‰²è®¾ç½® */
    .button-move {
      background-color: #FF1493; /* æ´‹çº¢è‰² */
    }
    .button-move:hover {background-color: #FF69B4}
    .button-move:active {
      background-color: #FF69B4;
      box-shadow: 0 5px #666;
      transform: translateY(4px);
    }

    /* å§¿æ€æŒ‰é’®çš„é¢œè‰²è®¾ç½® */
    .button-posture {
      background-color: #FFA500; /* ç§‘æŠ€æ°›å›´çš„æ©™è‰² */
    }
    .button-posture:hover {background-color: #FFB347}
    .button-posture:active {
      background-color: #FFB347;
      box-shadow: 0 5px #666;
      transform: translateY(4px);
    }

    /* å¾…æœºæ¨¡å¼çš„é¢œè‰²è®¾ç½® */
    .button-standby {
      background-color: #3A3A3A; /* å¤§ç–†æ— äººæœºç° */
    }
    .button-standby:hover {background-color: #4A4A4A}
    .button-standby:active {
      background-color: #4A4A4A;
      box-shadow: 0 5px #666;
      transform: translateY(4px);
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      justify-items: center;
      align-items: center;
      margin-top: 20px;
    }
    .grid-item-1 { grid-column: span 1; }
    .grid-item-2 { grid-column: span 2; }
    .grid-item-3 { grid-column: span 3; }
    .empty { visibility: hidden; }
    .empty-row { grid-column: span 3; height: 20px; }

    /* é€Ÿåº¦æ§åˆ¶åŒºåŸŸæ ·å¼ */
    .speed-control {
      max-width: 500px;
      margin: 10px auto;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .speed-label {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    /* é€Ÿåº¦æ¡£ä½æŒ‰é’®æ ·å¼ */
    .speed-levels {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .speed-btn {
      padding: 10px 20px;
      border: 2px solid #1E90FF;
      background-color: white;
      color: #1E90FF;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    .speed-btn:hover {
      background-color: #1E90FF;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(30, 144, 255, 0.3);
    }
    .speed-btn.active {
      background-color: #1E90FF;
      color: white;
      box-shadow: 0 2px 4px rgba(30, 144, 255, 0.3);
    }
    .speed-btn.active:hover {
      background-color: #0b7dda;
    }

    /* æ­¥æ€æ§åˆ¶åŒºåŸŸæ ·å¼ï¼ˆå•æŒ‰é’®ï¼šç‚¹å‡»å¾ªç¯åˆ‡æ¢ï¼‰ */
    .gait-control {
      max-width: 500px;
      margin: 10px auto;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: block;
    }
    .gait-label {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    /* å››è¶³æ­¥æ€ï¼šradio æ¨ªå‘å¸ƒå±€ */
    .gait-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .gait-radio {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border: 2px solid #28a745;
      background: #fff;
      color: #1f7a34;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    .gait-radio input {
      accent-color: #28a745;
      width: 16px;
      height: 16px;
      margin: 0;
    }
    .gait-radio.active {
      background: #28a745;
      color: #fff;
    }

    /* è¯•éªŒæ€§å¼€å…³ï¼ˆä»…å››è¶³æ˜¾ç¤ºï¼‰ */
    .gait-experimental-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #bbb;
      transition: .2s;
      border-radius: 999px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }
    .switch input:checked + .slider {
      background-color: #1E90FF;
    }
    .switch input:checked + .slider:before {
      transform: translateX(24px);
    }
    .gait-experimental-text {
      font-size: 14px;
      color: #333;
      font-weight: bold;
    }

    /* é¡µè„šç½²åæ ·å¼ */
    .footer {
      margin-top: 40px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      border-radius: 10px 10px 0 0;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
    }
    .footer-content {
      max-width: 800px;
      margin: 0 auto;
    }
    .footer-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: nowrap;
      margin-top: 12px;
    }
    .footer-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: white;
      text-decoration: none;
      font-size: 14px;
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      transition: all 0.3s;
    }
    .footer-link:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .footer-icon {
      width: 20px;
      height: 20px;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #1E90FF;
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }
    .close:hover {
      color: #000;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-input:focus {
      outline: none;
      border-color: #1E90FF;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-primary {
      flex: 1;
      padding: 10px;
      background-color: #1E90FF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .btn-primary:hover {
      background-color: #0b7dda;
    }
    .btn-secondary {
      flex: 1;
      padding: 10px;
      background-color: #666;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn-secondary:hover {
      background-color: #555;
    }
    .btn-danger {
      padding: 10px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      width: 100%;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .info-box {
      background-color: #e7f3ff;
      border-left: 4px solid #1E90FF;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 14px;
    }
    .wifi-qr {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    .wifi-qr-text {
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
      margin-top: 10px;
    }
    .status-message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <h1 class="title">
    <div class="header-actions-left">
      <button class="settings-btn" onclick="openSettings()" data-zh="âš™ï¸ è®¾ç½®" data-en="âš™ï¸ Settings">âš™ï¸ è®¾ç½®</button>
      <button class="planner-btn" id="plannerBtn" onclick="openPlanner()" title="è¿åŠ¨è§„åˆ’" aria-label="è¿åŠ¨è§„åˆ’" data-zh="ğŸ§­ è§„åˆ’" data-en="ğŸ§­ Planner">ğŸ§­ è§„åˆ’</button>
    </div>
    <span id="pageTitle">æœºå™¨äººæ§åˆ¶</span>
    <div class="header-actions-right">
      <button class="lang-switch" onclick="toggleLanguage()">English</button>
    </div>
  </h1>

  <center><span align="center" style="text-align: center; display: inline-block;padding: 5px; font-size: 120%;font-weight: bold;"><a style="width:200px; height:50px;" href="/calibration">
    <button id="CALIBRATEPAGE" type="button" onclick="buttonclick(this);" style="width:200px; height: 30px; Text-align: center;" data-zh="æ ¡å‡†ï¼šå¼€å§‹ | ä¿å­˜" data-en="Calibration: Start | Save">æ ¡å‡†ï¼šå¼€å§‹ | ä¿å­˜</button></a></span></center><br>

  <!-- é€Ÿåº¦æ§åˆ¶åŒºåŸŸ -->
  <div class="speed-control">
    <div class="speed-label">è¿åŠ¨é€Ÿåº¦æ§åˆ¶</div>
    <div class="speed-levels">
      <button class="speed-btn" data-speed="0.25" data-zh="ææ…¢" data-en="Slowest">ææ…¢</button>
      <button class="speed-btn" data-speed="0.33" data-zh="æ…¢é€Ÿ" data-en="Slow">æ…¢é€Ÿ</button>
      <button class="speed-btn active" data-speed="0.5" data-zh="ä¸­é€Ÿ" data-en="Medium">ä¸­é€Ÿ</button>
      <button class="speed-btn" data-speed="1.0" data-zh="å¿«é€Ÿ" data-en="Fastest">å¿«é€Ÿ</button>
    </div>
  </div>

  <!-- æ­¥æ€æ§åˆ¶åŒºåŸŸï¼ˆå•æŒ‰é’®äº¤äº’ï¼šç‚¹å‡»å¾ªç¯åˆ‡æ¢ï¼›å…­è¶³å›ºå®šé»˜è®¤æ­¥æ€ï¼‰ -->
  <div class="gait-control" id="gaitControl">
    <div class="gait-label" id="gaitLabel">æ­¥æ€æ¨¡å¼</div>
    <!-- ä»…å››è¶³æ˜¾ç¤ºï¼šè¯•éªŒæ€§å¼€å…³ -->
    <div class="gait-experimental-row" id="gaitExperimentalRow" style="display:none;">
      <label class="switch" title="Experimental gaits">
        <input type="checkbox" id="gaitExperimentalToggle">
        <span class="slider"></span>
      </label>
      <span class="gait-experimental-text" id="gaitExperimentalText" data-zh="è¯•éªŒæ€§" data-en="Experimental">è¯•éªŒæ€§</span>
    </div>
    <!-- ä»…å››è¶³æ˜¾ç¤ºï¼šradio button é€‰æ‹© -->
    <div class="gait-options" id="gaitOptions"></div>
  </div>
  
  <div class="grid-container">
    <button class="button button-posture grid-item-1" onclick="sendCommand(9)" data-zh="æ—‹è½¬X" data-en="RotateX">æ—‹è½¬X</button>
    <button class="button button-posture grid-item-1" onclick="sendCommand(10)" data-zh="æ—‹è½¬Y" data-en="RotateY">æ—‹è½¬Y</button>
    <button class="button button-posture grid-item-1" onclick="sendCommand(11)" data-zh="æ—‹è½¬Z" data-en="RotateZ">æ—‹è½¬Z</button>
    <button class="button button-posture grid-item-3" onclick="sendCommand(12)" data-zh="æ‰­è…°" data-en="Twist">æ‰­è…°</button>
    
    <div class="empty-row"></div>
    
    <button class="button grid-item-1" onclick="sendCommand(4)" data-zh="å·¦è½¬" data-en="TurnLeft">å·¦è½¬</button>
    <div class="empty grid-item-1"></div>
    <button class="button grid-item-1" onclick="sendCommand(5)" data-zh="å³è½¬" data-en="TurnRight">å³è½¬</button>
    
    <button class="button grid-item-1" onclick="sendCommand(2)" data-zh="å¿«è·‘" data-en="Run">å¿«è·‘</button>
    <button class="button button-move grid-item-1" onclick="sendCommand(1)" data-zh="å‰è¿›" data-en="Forward">å‰è¿›</button>
    <button class="button grid-item-1" onclick="sendCommand(8)" data-zh="çˆ¬è¡Œ" data-en="Climb">çˆ¬è¡Œ</button>
    
    <button class="button button-move grid-item-1" onclick="sendCommand(6)" data-zh="å·¦ç§»" data-en="ShiftLeft">å·¦ç§»</button>
    <button class="button button-standby grid-item-1" onclick="sendCommand(0)" data-zh="å¾…æœº" data-en="Standby">å¾…æœº</button>
    <button class="button button-move grid-item-1" onclick="sendCommand(7)" data-zh="å³ç§»" data-en="ShiftRight">å³ç§»</button>
    <button class="button button-move grid-item-3" onclick="sendCommand(3)" data-zh="åé€€" data-en="Backward">åé€€</button>
  </div>

  <!-- APé…ç½®æ¨¡æ€æ¡† -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title" id="modalTitle">WiFi AP é…ç½®</span>
        <span class="close" onclick="closeSettings()">&times;</span>
      </div>
      <div id="settingsForm">
        <div class="form-group">
          <label class="form-label" id="labelSSID">AP åç§° (SSID)</label>
          <input type="text" id="apSSID" class="form-input" placeholder="NodeHexa-XXXX" maxlength="31">
        </div>
        <div class="form-group">
          <label class="form-label" id="labelPassword">å¯†ç  (8-63å­—ç¬¦ï¼Œç•™ç©ºä¸ºå¼€æ”¾ç½‘ç»œ)</label>
          <input type="password" id="apPassword" class="form-input" placeholder="ç•™ç©ºä¸ºå¼€æ”¾ç½‘ç»œ" maxlength="63">
        </div>
        <div class="info-box" id="currentInfo">
          <strong>å½“å‰é…ç½®ï¼š</strong><br>
          <span id="currentSSID">åŠ è½½ä¸­...</span>
        </div>
        <div class="form-actions">
          <button class="btn-primary" onclick="saveAPConfig()" id="btnSave">ä¿å­˜</button>
          <button class="btn-secondary" onclick="closeSettings()" id="btnCancel">å–æ¶ˆ</button>
        </div>
        <button class="btn-danger" onclick="resetAPConfig()" id="btnReset">æ¢å¤é»˜è®¤é…ç½®</button>
        <div class="status-message" id="statusMessage"></div>
      </div>
      <div id="pendingInfo" style="display: none;">
        <div class="info-box">
          <strong>é…ç½®å·²æ›´æ–°ï¼</strong><br>
          <p id="pendingMessage">è®¾å¤‡å°†åœ¨3ç§’åé‡å¯ï¼Œè¯·è¿æ¥åˆ°æ–°çš„APï¼š</p>
          <div class="wifi-qr">
            <div><strong id="newSSID">-</strong></div>
            <div id="newPassword" style="margin-top: 5px;"></div>
            <div class="wifi-qr-text" id="wifiQRText"></div>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 10px;">
            è¿æ¥åè®¿é—® http://192.168.4.1 å®Œæˆç¡®è®¤
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- é¡µè„šç½²å -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-title" id="footerTitle">å¼€æºé¡¹ç›® Â· NodeHexa æœºå™¨äºº</div>
      <div class="footer-links">
        <a href="https://space.bilibili.com/85652131" target="_blank" class="footer-link" title="Bç«™ä¸»é¡µ">
          <svg class="footer-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/>
          </svg>
          <span id="bilibiliText">Bç«™: æ™ºé€ å¸ˆ_RoboticsCV</span>
        </a>
        <a href="https://github.com/ViolinLee" target="_blank" class="footer-link" title="GitHubä¸»é¡µ">
          <svg class="footer-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/>
          </svg>
          <span id="githubText">GitHub: ViolinLee</span>
        </a>
        <span class="footer-link" title="å¾®ä¿¡å…¬ä¼—å·" style="cursor: default;">
          <svg class="footer-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-4.972 1.932-6.446 1.703-1.415 3.882-1.98 5.853-1.838-.576-3.583-4.196-6.348-8.596-6.348zM5.785 5.991c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178A1.17 1.17 0 0 1 4.623 7.17c0-.651.52-1.18 1.162-1.18zm5.813 0c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178 1.17 1.17 0 0 1-1.162-1.178c0-.651.52-1.18 1.162-1.18zm5.34 2.867c-1.797-.052-3.746.512-5.28 1.786-1.72 1.428-2.687 3.72-1.78 6.22.942 2.453 3.666 4.229 6.884 4.229.826 0 1.622-.12 2.361-.336a.722.722 0 0 1 .598.082l1.584.926a.272.272 0 0 0 .14.047c.134 0 .24-.111.24-.247 0-.06-.023-.12-.038-.177l-.327-1.233a.582.582 0 0 1-.023-.156.49.49 0 0 1 .201-.398C23.024 18.48 24 16.82 24 14.98c0-3.21-2.931-5.837-6.656-6.088V8.89c-.135-.01-.27-.027-.407-.03zm-2.53 3.274c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.969-.982zm4.844 0c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.969-.982z"/>
          </svg>
          <span id="wechatText">å…¬ä¼—å·: RoboticsCV</span>
        </span>
      </div>
    </div>
  </footer>
  
  <script>
    var webSocketCarInputUrl = "ws:\/\/" + window.location.hostname + "/cmd"; 
    let websocketCarInput;

    // ä½ç”µé‡é”å­˜ï¼šä¸€æ—¦è§¦å‘ï¼Œç›´åˆ°é‡å¯æ‰ä¼šæ¢å¤
    let lowBatteryLatched = false;
    const lowBatteryMessages = {
      zh: 'ç”µé‡ä½ï¼Œè¯·å…³é—­ç”µæºåè¿›è¡Œå……ç”µï¼',
      en: 'Low battery. Please power off and recharge.'
    };

    function getLowBatteryMessage() {
      return (typeof currentLang !== 'undefined' && currentLang === 'en') ? lowBatteryMessages.en : lowBatteryMessages.zh;
    }

    function guardLowBattery() {
      if (lowBatteryLatched) {
        alert(getLowBatteryMessage());
        return true;
      }
      return false;
    }

    function initRobotInputWebSocket() {
      websocketCarInput = new WebSocket(webSocketCarInputUrl);
      websocketCarInput.onopen = function(event) {
        console.log('WebSocket is open now.');
      };
      websocketCarInput.onclose = function(event) {
        console.log('WebSocket is closed now. Reconnecting...');
        setTimeout(initRobotInputWebSocket, 2000);
      };
      websocketCarInput.onmessage = function(event) {
        try {
          const msg = JSON.parse(event.data);

          // ä½ç”µé‡äº‹ä»¶ï¼šå›ºä»¶é”å­˜åä¸»åŠ¨é€šçŸ¥
          if (msg && msg.event === 'lowBattery') {
            lowBatteryLatched = true;
            alert(msg.message || getLowBatteryMessage());
            return;
          }

          // å…¼å®¹ï¼šå›ºä»¶ä¹Ÿå¯èƒ½è¿”å› {status:"error", message:"..."}
          if (msg && msg.status === 'error' && msg.message) {
            // è·Ÿéšå›ºä»¶å½“å‰æ¶ˆæ¯ï¼šç²¾ç¡®åŒ¹é…ä½ç”µé‡æç¤º
            if (String(msg.message) === lowBatteryMessages.zh) {
              lowBatteryLatched = true;
              alert(msg.message || getLowBatteryMessage());
              return;
            }
          }
        } catch (_) {
          // ignore non-JSON payload
        }
      };
    }

    function sendCommand(commandMode) {
      if (guardLowBattery()) return;
      let command = 0;
      command |= (1<<commandMode);
      if (websocketCarInput && websocketCarInput.readyState === WebSocket.OPEN) {
        websocketCarInput.send(JSON.stringify({movementMode: command}));
        console.log('Sent command: ' + command);
      } else {
        console.log('WebSocket is not open. Cannot send command.');
      }
    }

    function sendSpeed(speed) {
      if (guardLowBattery()) return;
      if (websocketCarInput && websocketCarInput.readyState === WebSocket.OPEN) {
        websocketCarInput.send(JSON.stringify({speed: parseFloat(speed)}));
        console.log('Sent speed: ' + speed);
      } else {
        console.log('WebSocket is not open. Cannot send speed.');
      }
    }

    function sendGaitMode(gaitMode) {
      if (guardLowBattery()) return;
      if (websocketCarInput && websocketCarInput.readyState === WebSocket.OPEN) {
        websocketCarInput.send(JSON.stringify({gaitMode: parseInt(gaitMode, 10)}));
        console.log('Sent gaitMode: ' + gaitMode);
      } else {
        console.log('WebSocket is not open. Cannot send gaitMode.');
      }
    }

    // æ­¥æ€æ§åˆ¶ï¼ˆä»…å››è¶³éœ€è¦ï¼›å…­è¶³ä¸æ˜¾ç¤ºï¼‰
    let robotType = 'hexa';
    let currentGait = 3; // å››è¶³é»˜è®¤åŒåŒ(Creep)
    let experimentalGaitsEnabled = false; // é»˜è®¤ä¸æ‰“å¼€è¯•éªŒæ€§
    const gaitNames = {
      0: { zh: 'å°è·‘', en: 'Trot' },
      1: { zh: 'æ…¢èµ°', en: 'Walk' },
      2: { zh: 'ç–¾é©°', en: 'Gallop' },
      3: { zh: 'åŒåŒ', en: 'Creep' }
    };

    const GAITS_STABLE = [3, 1];      // é»˜è®¤ä»…å¼€æ”¾ï¼šCreep + Walk
    const GAITS_ALL = [3, 1, 0, 2];   // æ‰“å¼€è¯•éªŒæ€§ï¼šCreep, Walk, Trot, Gallopï¼ˆæŒ‰ä½“éªŒæ’åºï¼‰

    function getSupportedGaitsForQuad() {
      return experimentalGaitsEnabled ? GAITS_ALL : GAITS_STABLE;
    }

    function normalizeCurrentGaitForQuad() {
      const supported = getSupportedGaitsForQuad();
      if (!supported.includes(currentGait)) {
        currentGait = 3; // å›é€€åˆ° creep
      }
    }

    function renderGaitRadios() {
      const optionsEl = document.getElementById('gaitOptions');
      if (!optionsEl) return;
      optionsEl.innerHTML = '';

      if (robotType !== 'quad') return; // å…­è¶³ä¸æ¸²æŸ“

      normalizeCurrentGaitForQuad();

      const supported = getSupportedGaitsForQuad();
      supported.forEach((g) => {
        const label = document.createElement('label');
        label.className = 'gait-radio' + (g === currentGait ? ' active' : '');
        label.setAttribute('data-gait', String(g));

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'gaitMode';
        input.value = String(g);
        input.checked = (g === currentGait);

        const span = document.createElement('span');
        span.textContent = gaitNames[g] ? gaitNames[g][currentLang] : String(g);

        label.appendChild(input);
        label.appendChild(span);
        optionsEl.appendChild(label);

        input.addEventListener('change', () => {
          if (!input.checked) return;

          // çº¦æŸï¼šå›ºä»¶ä¾§ä»…å…è®¸åœ¨å¾…æœºæ¨¡å¼åˆ‡æ¢æ­¥æ€
          // ä½“éªŒä¼˜åŒ–ï¼šå…ˆä¸‹å‘å¾…æœºï¼Œå†ä¸‹å‘ gaitMode
          sendCommand(0);
          currentGait = g;

          try {
            window.localStorage.setItem('gaitMode', String(currentGait));
          } catch (_) {
            // ignore
          }

          // æ›´æ–° active æ ·å¼
          const all = optionsEl.querySelectorAll('.gait-radio');
          all.forEach((el) => el.classList.remove('active'));
          label.classList.add('active');

          setTimeout(() => sendGaitMode(currentGait), 180);
        });
      });
    }

    function renderGaitExperimentalToggle() {
      const row = document.getElementById('gaitExperimentalRow');
      const toggle = document.getElementById('gaitExperimentalToggle');
      const text = document.getElementById('gaitExperimentalText');
      if (!row || !toggle || !text) return;

      if (robotType !== 'quad') {
        row.style.display = 'none';
        return;
      }

      row.style.display = 'flex';
      toggle.checked = !!experimentalGaitsEnabled;
      text.textContent = text.getAttribute('data-' + currentLang) || text.textContent;
    }

    function updateGaitControlVisibility() {
      const container = document.getElementById('gaitControl');
      if (!container) return;
      // å…­è¶³ä¸éœ€è¦æ­¥æ€åˆ‡æ¢å…¥å£
      container.style.display = (robotType === 'quad') ? 'block' : 'none';
    }

    function initSpeedControl() {
      const speedButtons = document.querySelectorAll('.speed-btn');
      
      let currentSpeed = 0.5; // é»˜è®¤ä¸­é€Ÿ
      
      // æ¡£ä½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      speedButtons.forEach(button => {
        button.addEventListener('click', function() {
          // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
          speedButtons.forEach(btn => btn.classList.remove('active'));
          // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
          this.classList.add('active');
          
          // æ›´æ–°å½“å‰é€Ÿåº¦å€¼
          currentSpeed = parseFloat(this.dataset.speed);
          
          // å‘é€é€Ÿåº¦å‘½ä»¤
          sendSpeed(currentSpeed);
          
          console.log('é€Ÿåº¦å·²åˆ‡æ¢åˆ°: ' + this.textContent + ' (å€¼: ' + currentSpeed + ')');
        });
      });
    }

    function initGaitControl() {
      // æ¢å¤æœ¬åœ°ç¼“å­˜ï¼ˆä»…å››è¶³ç”Ÿæ•ˆï¼‰
      try {
        const saved = window.localStorage.getItem('gaitMode');
        if (saved !== null && saved !== undefined && saved !== '') {
          const v = parseInt(saved, 10);
          if (!Number.isNaN(v) && v >= 0 && v <= 3) currentGait = v;
        }
      } catch (_) {
        // ignore
      }

      try {
        const savedExp = window.localStorage.getItem('experimentalGaits');
        if (savedExp === '1' || savedExp === 'true') experimentalGaitsEnabled = true;
        if (savedExp === '0' || savedExp === 'false') experimentalGaitsEnabled = false;
      } catch (_) {
        // ignore
      }

      const toggle = document.getElementById('gaitExperimentalToggle');
      if (toggle) {
        toggle.addEventListener('change', () => {
          experimentalGaitsEnabled = !!toggle.checked;
          try {
            window.localStorage.setItem('experimentalGaits', experimentalGaitsEnabled ? '1' : '0');
          } catch (_) {
            // ignore
          }
          renderGaitExperimentalToggle();
          renderGaitRadios();
        });
      }

      // å…ˆæŒ‰é»˜è®¤ robotType æ¸²æŸ“ä¸€æ¬¡ï¼ˆåç»­ loadCaps ä¼šå†æ¬¡åˆ·æ–°ï¼‰
      updateGaitControlVisibility();
      renderGaitExperimentalToggle();
      renderGaitRadios();
    }

    // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
    let currentLang = 'zh'; // é»˜è®¤ä¸­æ–‡

    const langTexts = {
      pageTitle: { zh: 'æœºå™¨äººæ§åˆ¶', en: 'Robot Control' },
      langButton: { zh: 'English', en: 'ä¸­æ–‡' },
      speedLabel: { zh: 'è¿åŠ¨é€Ÿåº¦æ§åˆ¶', en: 'Movement Speed Control' },
      gaitLabel: { zh: 'æ­¥æ€æ¨¡å¼', en: 'Gait Mode' },
      footerTitle: { zh: 'å¼€æºé¡¹ç›® Â· NodeHexa æœºå™¨äºº', en: 'Open Source Â· NodeHexa Robot' },
      bilibiliText: { zh: 'Bç«™: æ™ºé€ å¸ˆ_RoboticsCV', en: 'Bilibili: æ™ºé€ å¸ˆ_RoboticsCV' },
      githubText: { zh: 'GitHub: ViolinLee', en: 'GitHub: ViolinLee' },
      wechatText: { zh: 'å…¬ä¼—å·: RoboticsCV', en: 'WeChat: RoboticsCV' },
      settingsBtn: { zh: 'âš™ï¸ è®¾ç½®', en: 'âš™ï¸ Settings' },
      modalTitle: { zh: 'WiFi AP é…ç½®', en: 'WiFi AP Settings' },
      labelSSID: { zh: 'AP åç§° (SSID)', en: 'AP Name (SSID)' },
      labelPassword: { zh: 'å¯†ç  (8-63å­—ç¬¦ï¼Œç•™ç©ºä¸ºå¼€æ”¾ç½‘ç»œ)', en: 'Password (8-63 chars, empty for open network)' },
      btnSave: { zh: 'ä¿å­˜', en: 'Save' },
      btnCancel: { zh: 'å–æ¶ˆ', en: 'Cancel' },
      btnReset: { zh: 'æ¢å¤é»˜è®¤é…ç½®', en: 'Reset to Default' },
      currentConfig: { zh: 'å½“å‰é…ç½®ï¼š', en: 'Current Config: ' },
      pendingMsg: { zh: 'è®¾å¤‡å°†åœ¨3ç§’åé‡å¯ï¼Œè¯·è¿æ¥åˆ°æ–°çš„APï¼š', en: 'Device will reboot in 3 seconds, please connect to new AP:' },
      pendingHint: { zh: 'è¿æ¥åè®¿é—® http://192.168.4.1 å®Œæˆç¡®è®¤', en: 'Visit http://192.168.4.1 after connecting to confirm' }
    };

    function toggleLanguage() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      
      // æ›´æ–°é¡µé¢æ ‡é¢˜
      document.getElementById('pageTitle').textContent = langTexts.pageTitle[currentLang];
      
      // æ›´æ–°è¯­è¨€åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
      document.querySelector('.lang-switch').textContent = langTexts.langButton[currentLang];
      
      // æ›´æ–°é€Ÿåº¦æ§åˆ¶åŒºåŸŸæ–‡æœ¬
      document.querySelector('.speed-label').textContent = langTexts.speedLabel[currentLang];

      // æ›´æ–°æ­¥æ€æ§åˆ¶åŒºåŸŸæ–‡æœ¬
      const gaitLabelEl = document.getElementById('gaitLabel');
      if (gaitLabelEl) gaitLabelEl.textContent = langTexts.gaitLabel[currentLang];
      renderGaitExperimentalToggle();
      renderGaitRadios();
      
      // æ›´æ–°é€Ÿåº¦æ¡£ä½æŒ‰é’®æ–‡æœ¬
      const speedButtons = document.querySelectorAll('.speed-btn[data-zh][data-en]');
      speedButtons.forEach(button => {
        button.textContent = button.getAttribute('data-' + currentLang);
      });

      // æ›´æ–°æ‰€æœ‰æŒ‰é’®æ–‡æœ¬
      const buttons = document.querySelectorAll('.button[data-zh][data-en]');
      buttons.forEach(button => {
        button.textContent = button.getAttribute('data-' + currentLang);
      });

      // æ›´æ–°æ ¡å‡†å…¥å£æŒ‰é’®æ–‡æœ¬
      const calibrateBtn = document.getElementById('CALIBRATEPAGE');
      if (calibrateBtn) {
        const t = calibrateBtn.getAttribute('data-' + currentLang);
        if (t) calibrateBtn.textContent = t;
      }
      
      // æ›´æ–°è®¾ç½®æŒ‰é’®æ–‡æœ¬
      const settingsBtn = document.querySelector('.settings-btn');
      if (settingsBtn) {
        settingsBtn.textContent = langTexts.settingsBtn[currentLang];
      }

      // æ›´æ–°â€œè¿åŠ¨è§„åˆ’å™¨â€å…¥å£æ ‡é¢˜ï¼ˆå›¾æ ‡æŒ‰é’®æ— éœ€åˆ‡æ¢æ–‡æœ¬ï¼‰
      const plannerBtn = document.getElementById('plannerBtn');
      if (plannerBtn) {
        plannerBtn.textContent = plannerBtn.getAttribute('data-' + currentLang) || plannerBtn.textContent;
        plannerBtn.title = (currentLang === 'zh') ? 'è¿åŠ¨è§„åˆ’' : 'Motion Planner';
        plannerBtn.setAttribute('aria-label', plannerBtn.title);
      }
      
      // æ›´æ–°é¡µè„šæ–‡æœ¬
      document.getElementById('footerTitle').textContent = langTexts.footerTitle[currentLang];
      document.getElementById('bilibiliText').textContent = langTexts.bilibiliText[currentLang];
      document.getElementById('githubText').textContent = langTexts.githubText[currentLang];
      document.getElementById('wechatText').textContent = langTexts.wechatText[currentLang];
      
      // æ›´æ–°æ¨¡æ€æ¡†æ–‡æœ¬
      updateModalTexts();
      
      console.log('Language switched to: ' + (currentLang === 'zh' ? 'ä¸­æ–‡' : 'English'));
    }

    function updateModalTexts() {
      document.getElementById('modalTitle').textContent = langTexts.modalTitle[currentLang];
      document.getElementById('labelSSID').textContent = langTexts.labelSSID[currentLang];
      document.getElementById('labelPassword').textContent = langTexts.labelPassword[currentLang];
      document.getElementById('btnSave').textContent = langTexts.btnSave[currentLang];
      document.getElementById('btnCancel').textContent = langTexts.btnCancel[currentLang];
      document.getElementById('btnReset').textContent = langTexts.btnReset[currentLang];
      const currentInfo = document.getElementById('currentInfo');
      if (currentInfo) {
        currentInfo.innerHTML = '<strong>' + langTexts.currentConfig[currentLang] + '</strong><br><span id="currentSSID">åŠ è½½ä¸­...</span>';
      }
    }

    async function loadCapsAndUpdateFooter() {
      try {
        const resp = await fetch('/api/caps', { cache: 'no-store' });
        const data = await resp.json();
        const type = data && data.robot && data.robot.type ? data.robot.type : 'hexa';
        robotType = type;
        lowBatteryLatched = !!(data && data.power && data.power.lowBatteryLatched);

        if (type === 'quad') {
          // å››è¶³ï¼šé»˜è®¤æ­¥æ€ä¸º creep(3)ï¼Œè‹¥æœ¬åœ°ç¼“å­˜éæ³•åˆ™å›é€€åˆ°é»˜è®¤
          if (typeof currentGait !== 'number' || Number.isNaN(currentGait) || currentGait < 0 || currentGait > 3) {
            currentGait = 3;
          }
        } else {
          // å…­è¶³ï¼šä¸éœ€è¦æ­¥æ€ UI
          currentGait = 0;
        }

        updateGaitControlVisibility();
        renderGaitExperimentalToggle();
        renderGaitRadios();
        if (type === 'quad') {
          langTexts.footerTitle = { zh: 'å¼€æºé¡¹ç›® Â· NodeQuadMini å››è¶³æœºå™¨äºº', en: 'Open Source Â· NodeQuadMini Quadruped Robot' };
        } else {
          langTexts.footerTitle = { zh: 'å¼€æºé¡¹ç›® Â· NodeHexa å…­è¶³æœºå™¨äºº', en: 'Open Source Â· NodeHexa Hexapod Robot' };
        }
        document.getElementById('footerTitle').textContent = langTexts.footerTitle[currentLang];
      } catch (_) {
        // ignore
      }
    }

    // AP é…ç½®åŠŸèƒ½
    function openSettings() {
      document.getElementById('settingsModal').style.display = 'block';
      loadAPConfig();
    }

    function openPlanner() {
      window.location.href = '/planner';
    }

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
      document.getElementById('settingsForm').style.display = 'block';
      document.getElementById('pendingInfo').style.display = 'none';
      document.getElementById('statusMessage').style.display = 'none';
    }

    function loadAPConfig() {
      fetch('/api/ap-config?includePassword=true')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            if (data.pending) {
              // æ˜¾ç¤ºå¾…ç¡®è®¤ä¿¡æ¯
              document.getElementById('settingsForm').style.display = 'none';
              document.getElementById('pendingInfo').style.display = 'block';
              document.getElementById('newSSID').textContent = data.nextSSID || data.ssid;
              if (data.nextPassword) {
                document.getElementById('newPassword').textContent = 'å¯†ç : ' + data.nextPassword;
                document.getElementById('wifiQRText').textContent = 'WIFI:T:WPA;S:' + data.nextSSID + ';P:' + data.nextPassword + ';;';
              } else {
                document.getElementById('newPassword').textContent = 'å¼€æ”¾ç½‘ç»œï¼ˆæ— å¯†ç ï¼‰';
                document.getElementById('wifiQRText').textContent = 'WIFI:T:nopass;S:' + data.nextSSID + ';;';
              }
              document.getElementById('pendingMessage').textContent = langTexts.pendingMsg[currentLang];
              document.querySelector('#pendingInfo p[style]').textContent = langTexts.pendingHint[currentLang];
            } else {
              // æ˜¾ç¤ºå½“å‰é…ç½®
              document.getElementById('apSSID').value = data.ssid || '';
              document.getElementById('apPassword').value = data.password || '';
              document.getElementById('currentSSID').textContent = data.ssid + (data.password ? ' (å·²è®¾ç½®å¯†ç )' : ' (å¼€æ”¾ç½‘ç»œ)');
            }
          }
        })
        .catch(error => {
          console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
          showStatus('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
        });
    }

    function saveAPConfig() {
      const ssid = document.getElementById('apSSID').value.trim();
      const password = document.getElementById('apPassword').value;

      if (!ssid) {
        showStatus('è¯·è¾“å…¥APåç§°', 'error');
        return;
      }

      if (ssid.length > 31) {
        showStatus('APåç§°ä¸èƒ½è¶…è¿‡31ä¸ªå­—ç¬¦', 'error');
        return;
      }

      if (password && password.length > 0 && password.length < 8) {
        showStatus('å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦', 'error');
        return;
      }

      const config = {
        ssid: ssid,
        password: password
      };

      fetch('/api/ap-config', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // æ˜¾ç¤ºå¾…ç¡®è®¤ä¿¡æ¯
            document.getElementById('settingsForm').style.display = 'none';
            document.getElementById('pendingInfo').style.display = 'block';
            document.getElementById('newSSID').textContent = data.nextSSID;
            if (data.nextPassword) {
              document.getElementById('newPassword').textContent = 'å¯†ç : ' + data.nextPassword;
              document.getElementById('wifiQRText').textContent = 'WIFI:T:WPA;S:' + data.nextSSID + ';P:' + data.nextPassword + ';;';
            } else {
              document.getElementById('newPassword').textContent = 'å¼€æ”¾ç½‘ç»œï¼ˆæ— å¯†ç ï¼‰';
              document.getElementById('wifiQRText').textContent = 'WIFI:T:nopass;S:' + data.nextSSID + ';;';
            }
            document.getElementById('pendingMessage').textContent = langTexts.pendingMsg[currentLang];
            document.querySelector('#pendingInfo p[style]').textContent = langTexts.pendingHint[currentLang];
          } else {
            showStatus('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        })
        .catch(error => {
          console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
          showStatus('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
        });
    }

    function resetAPConfig() {
      if (!confirm(currentLang === 'zh' ? 'ç¡®å®šè¦æ¢å¤é»˜è®¤é…ç½®å—ï¼Ÿè®¾å¤‡å°†é‡å¯ã€‚' : 'Reset to default? Device will reboot.')) {
        return;
      }

      // ä¸ºé¿å…è®¾å¤‡é‡å¯å¯¼è‡´è¯·æ±‚æŒ‚èµ·ï¼Œå¢åŠ è¶…æ—¶æ§åˆ¶ï¼›è¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯å‡è§†ä¸ºå·²ä¸‹å‘é‡å¯æŒ‡ä»¤
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 3500);

      // ä½¿ç”¨ GET æäº¤å¤ä½è¯·æ±‚ï¼Œåç«¯åŒæ—¶æ”¯æŒ GET/POST
      fetch('/api/ap-config/reset', { signal: controller.signal })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            showStatus(currentLang === 'zh' ? 'å·²æ¢å¤é»˜è®¤é…ç½®ï¼Œè®¾å¤‡å°†é‡å¯' : 'Reset to default, device will reboot', 'success');
            setTimeout(() => {
              closeSettings();
            }, 2000);
          } else {
            showStatus('é‡ç½®å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        })
        .catch(error => {
          // å°†ç½‘ç»œå¤±è´¥/è¶…æ—¶è§†ä¸ºè®¾å¤‡æ­£åœ¨é‡å¯ï¼Œç»™å‡ºæ­£å‘æç¤ºï¼Œé¿å…â€œFailed to fetchâ€è¯¯å¯¼
          showStatus(currentLang === 'zh' ? 'å·²æ¢å¤é»˜è®¤é…ç½®ï¼Œè®¾å¤‡å°†é‡å¯' : 'Reset to default, device will reboot', 'success');
          setTimeout(() => {
            closeSettings();
          }, 2000);
        })
        .finally(() => {
          clearTimeout(timeoutId);
        });
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message status-' + type;
      statusEl.style.display = 'block';
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 5000);
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      const modal = document.getElementById('settingsModal');
      if (event.target === modal) {
        closeSettings();
      }
    }

    window.onload = async function() {
      initRobotInputWebSocket();
      initSpeedControl();
      initGaitControl();
      // é»˜è®¤æ˜¾ç¤ºä¸­æ–‡ï¼Œæ— éœ€è°ƒç”¨toggleLanguage
      updateModalTexts();
      // åˆå§‹åŒ–æ ‡é¢˜æ æŒ‰é’® title
      const plannerBtn = document.getElementById('plannerBtn');
      if (plannerBtn) {
        plannerBtn.title = 'è¿åŠ¨è§„åˆ’';
        plannerBtn.setAttribute('aria-label', 'è¿åŠ¨è§„åˆ’');
      }
      await loadCapsAndUpdateFooter();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å¾…ç¡®è®¤çš„é…ç½®
      fetch('/api/ap-config')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.pending) {
            // è‡ªåŠ¨ç¡®è®¤ pending é…ç½®ï¼ˆç”¨æˆ·å·²åœ¨æ–° AP ä¸‹è®¿é—®é¡µé¢ï¼‰
            fetch('/api/ap-config/confirm', { method: 'POST' })
              .then(() => console.log('APé…ç½®å·²ç¡®è®¤'));
          }
        })
        .catch(error => console.error('æ£€æŸ¥é…ç½®çŠ¶æ€å¤±è´¥:', error));
    };
  </script>
</body>
</html>