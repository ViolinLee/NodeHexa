# 2.1 核心控制器

## 2.1.1 NodeMCU32S 开发板

**开发板型号：** NodeMCU32S（基于ESP32芯片）

**主要特性：**
- **芯片：** ESP32（双核处理器）
- **Flash：** 4MB（默认配置）
- **RAM：** 520KB SRAM
- **WiFi：** 802.11 b/g/n（支持AP和STA模式）
- **蓝牙：** 未使用（本项目仅使用WiFi）

**开发环境配置：**
- **平台：** Espressif32
- **开发板：** nodemcu-32s
- **框架：** arduino
- **Flash模式：** DIO（Dual I/O）
- **串口波特率：** 115200

**引脚使用：**

| 功能 | GPIO引脚 | 说明 |
|------|----------|------|
| I2C SDA | GPIO21 | PCA9685数据线 |
| I2C SCL | GPIO22 | PCA9685时钟线 |
| UART2 RX | GPIO16 | 串口接收（可选） |
| UART2 TX | GPIO17 | 串口发送（可选） |
| 电池ADC | GPIO34 | 电池电压监测（仅输入） |
| 电池LED | GPIO25 | 低电压指示灯 |

**注意事项：**
- GPIO34是仅输入引脚，无法配置为输出
- I2C引脚已通过`Wire.setPins(21, 22)`明确指定
- UART2用于接收外部控制指令（可选功能）

# 2.2 执行机构

## 2.2.1 舵机规格

**TODO：** 需要补充舵机具体型号、扭矩、速度等规格参数

**软件配置参数：**

从代码中可获取的舵机配置信息：

**角度范围：**
- **关节1（根部关节）：** -45° ~ +45°
- **关节2（中间关节）：** -45° ~ +75°（特殊处理：方向反转）
- **关节3（末端关节）：** -60° ~ +60°

**PWM参数：**
- **PWM频率：** 50Hz（标准舵机频率）
- **中位脉宽：** 1500μs
- **最小脉宽：** 500μs
- **最大脉宽：** 2500μs
- **有效范围：** ±1000μs（对应±90°）

**控制特性：**
- 关节2需要方向反转（`inverse_ = true`）
- 关节2有15°的角度补偿（`adjust_angle_ = 15.0`）
- 每个舵机支持独立的校准偏移量（`offset_`）

**舵机数量：** 18个（6条腿 × 3个关节/腿）

## 2.2.2 舵机驱动板（PCA9685）

**驱动板型号：** PCA9685 PWM驱动板

**硬件配置：**
- **数量：** 2块PCA9685驱动板
- **I2C地址：**
  - 右侧驱动板：`0x40`（默认地址）
  - 左侧驱动板：`0x41`（需焊接跳帽设置地址）
- **PWM通道：** 每块16通道，共32通道
- **实际使用：** 18个通道（6条腿 × 3个关节）

**PWM配置：**
- **频率：** 50Hz（标准舵机频率）
- **分辨率：** 12位（4096级）
- **时钟周期：** 20ms（50Hz）
- **Tick精度：** 约5μs（1000000 / (50×4096)）

**通道分配：**

右侧驱动板（0x40）：
- 通道0-1：未使用
- 通道2-4：Leg 1（3个关节）
- 通道5-7：Leg 0（3个关节）
- 通道8-10：Leg 2（3个关节）
- 通道11-15：未使用

左侧驱动板（0x41）：
- 通道0-1：未使用
- 通道2-4：Leg 4（3个关节）
- 通道5-7：Leg 5（3个关节）
- 通道8-10：Leg 3（3个关节）
- 通道11-15：未使用

**I2C通信：**
- **总线：** I2C（Wire库）
- **速度：** 标准模式（100kHz）或快速模式（400kHz）
- **上拉电阻：** 驱动板内置（通常为2.2kΩ）

**库依赖：**
- `Adafruit PWM Servo Driver Library` v3.0.2
- 通过硬件抽象层（hal::PCA9685）封装

**TODO：** 需要补充驱动板的具体型号、购买链接、硬件连接图

# 2.3 机械结构

## 2.3.1 腿部结构参数

**腿部尺寸参数（单位：mm）：**

每条腿由4个连杆组成，尺寸如下：

| 参数名称 | 数值 | 说明 |
|----------|------|------|
| `kLegRootToJoint1` | 20.75 | 根关节到关节1的距离 |
| `kLegJoint1ToJoint2` | 28.0 | 关节1到关节2的距离 |
| `kLegJoint2ToJoint3` | 42.6 | 关节2到关节3的距离 |
| `kLegJoint3ToTip` | 89.07 | 关节3到足端的距离 |

**总长度：** 约180.42mm（从根关节到足端）

**腿索引定义：**

```
     leg5   leg0
     /        \
    /          \
 leg4          leg1
    \          /
     \        /
    leg3    leg2
```

**角度定义：**
- 关节1：绕Z轴旋转（水平面内）
- 关节2：控制垂直方向
- 关节3：控制足端倾斜角度

## 2.3.2 安装位置配置

**腿部安装位置（单位：mm）：**

六条腿在机器人本体上的安装位置：

| 腿编号 | X坐标 | Y坐标 | 安装角度 |
|--------|-------|-------|----------|
| Leg 0  | 22.41 | 55.41 | 45°      |
| Leg 1  | 29.87 | 0     | 0°       |
| Leg 2  | 22.41 | -55.41| -45°     |
| Leg 3  | -22.41| -55.41| 135°     |
| Leg 4  | -29.87| 0     | 180°     |
| Leg 5  | -22.41| 55.41 | 225°     |

**参数说明：**
- `kLegMountLeftRightX = 29.87`：左右两侧腿的X坐标
- `kLegMountOtherX = 22.41`：其他4条腿的X坐标
- `kLegMountOtherY = 55.41`：其他4条腿的Y坐标

**待机位置：**

机器人待机时，所有腿保持相同的姿态：
- **Z轴高度：** `-STANDBY_Z`（负值表示向下）
- **倾斜角度：** 15°（通过`COS15`和`SIN15`计算）
- **高度计算：** `STANDBY_Z = kLegJoint3ToTip × cos(15°) - kLegJoint2ToJoint3 × sin(30°)`

**TODO：** 需要补充完整的机械结构图纸、装配说明、3D模型文件

# 2.4 电源系统

## 2.4.1 电池规格

**TODO：** 需要补充电池类型、容量、标称电压、最大放电电流等规格参数

**电压监测参数：**

从代码中可获取的电源配置信息：

**低电压阈值：**
- **阈值电压：** 6.4V
- **ADC阈值：** 根据分压电路计算得出

**电压监测电路：**

使用分压电路将电池电压降至ADC可测量范围：

```
电池(+) ----[100kΩ]----+----[47kΩ]---- GND
                        |
                    ADC输入(GPIO34)
```

**分压比计算：**
- 分压比：`47 / (100 + 47) ≈ 0.3197`
- ESP32 ADC参考电压：3.3V
- ADC分辨率：12位（0-4095）

**ADC阈值计算：**
```cpp
ADC_THRESHOLD = 6.4V × (47 / 147) / 3.3V × 4095
              ≈ 6.4 × 0.3197 / 3.3 × 4095
              ≈ 2537
```

**实际电压计算：**
```cpp
实际电压 = ADC值 × 3.3 / 4095 × (100 + 47) / 47
        = ADC值 × 3.3 / 4095 × 3.1277
```

#### 2.4.2 电压监测电路

**硬件连接：**

| 元件 | 连接说明 |
|------|----------|
| 分压电阻1 | 100kΩ，连接电池正极和ADC输入 |
| 分压电阻2 | 47kΩ，连接ADC输入和GND |
| ADC输入 | GPIO34（仅输入引脚） |

**监测功能：**

1. **实时监测：** 通过FreeRTOS任务每1秒采样一次
2. **移动平均滤波：** 使用10个样本的移动平均降低噪声
3. **低电压告警：** 当电压低于6.4V时，LED指示灯闪烁
4. **保护机制：** 防止电池过放

**LED指示：**

- **引脚：** GPIO25
- **正常状态：** LED常灭
- **低电压状态：** LED闪烁（300ms周期）

**TODO：** 需要补充完整的电源电路图、电池安装说明、充电方式

### 2.5 其他硬件

#### 2.5.1 LED指示灯

**功能LED：** 电池低电压指示灯

**硬件配置：**
- **引脚：** GPIO25
- **功能：** 指示电池电压状态
- **控制方式：** 数字输出（HIGH/LOW）

**工作逻辑：**
- **正常电压：** LED保持低电平（常灭）
- **低电压：** LED以300ms周期闪烁
- **控制任务：** LEDControllerTask（FreeRTOS任务）

**TODO：** 需要补充LED型号、颜色、工作电流、限流电阻值

#### 2.5.2 通信接口

**WiFi接口：**

- **模式：** AP（Access Point）模式
- **SSID：** "NodeHexa"（默认）
- **密码：** "roboticscv666"（默认）
- **IP地址：** 192.168.4.1（ESP32默认AP IP）
- **端口：** HTTP 80，WebSocket /cmd

**串口接口：**

**UART0（调试串口）：**
- **用途：** 调试输出、固件烧录
- **波特率：** 115200
- **引脚：** GPIO1（TX）、GPIO3（RX）

**UART2（控制串口）：**
- **用途：** 接收外部控制指令
- **波特率：** 115200
- **引脚：** GPIO16（RX）、GPIO17（TX）
- **数据格式：** `$<JSON>\n`

**I2C接口：**

- **用途：** 与PCA9685驱动板通信
- **引脚：** GPIO21（SDA）、GPIO22（SCL）
- **速度：** 标准模式或快速模式
- **上拉电阻：** 驱动板内置

**SPIFFS文件系统：**

- **用途：** 存储校准数据、Web页面文件
- **存储位置：** Flash文件系统
- **文件：** `/calibration.json`（校准数据）

**TODO：** 需要补充完整的硬件连接图、接口定义图、通信协议详细说明

---
