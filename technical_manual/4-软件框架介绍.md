#  4.1 开发环境

##  4.1.1 PlatformIO简介

本项目使用 **PlatformIO** 作为主要开发平台。PlatformIO 是一个跨平台的嵌入式开发工具链，支持多种微控制器和开发板。

**主要优势：**
- 统一的包管理系统，易于管理依赖库
- 支持多平台、多框架开发
- 强大的构建系统和调试工具
- 与主流IDE（VS Code、CLion等）集成良好

**项目配置：**
- 平台：`espressif32`
- 开发板：`nodemcu-32s`
- 框架：`arduino`
- 固件版本：`1.1.0`（通过 `FIRMWARE_VERSION` 宏定义）

项目配置文件位于 `platformio.ini`，包含编译选项、库依赖、上传端口等设置。

##  4.1.2 Arduino框架

本项目基于 **Arduino 框架**开发，充分利用了Arduino生态系统的丰富库资源。

**使用的核心库：**
- `Wire.h`：I2C通信库，用于PCA9685舵机驱动板通信
- `WiFi.h`：WiFi功能库，支持AP模式
- `SPIFFS.h`：SPIFFS文件系统，用于存储校准数据等
- `HardwareSerial.h`：硬件串口库，用于UART2通信

**第三方依赖库：**
- `Adafruit PWM Servo Driver Library` (v3.0.2)：PCA9685 PWM驱动库
- `ESPAsyncWebServer`：异步Web服务器库，提供Web控制界面
- `ArduinoJson`：JSON解析和生成库，用于通信协议

#  4.2 代码结构

##  4.2.1 目录结构说明

```
firmware/
├── platformio.ini          # PlatformIO项目配置文件
├── src/                     # 源代码目录
│   ├── main.cpp            # 主程序入口
│   ├── hexapod.h/cpp       # 六足机器人主类
│   ├── leg.h/cpp           # 腿部类
│   ├── movement.h/cpp      # 动作类
│   ├── movements.cpp       # 动作表定义和映射
│   ├── servo.h/cpp         # 舵机控制类
│   ├── base.h              # 基础数据结构（Point3D, Locations）
│   ├── calibration.h/cpp   # 校准功能
│   ├── debug.h/cpp         # 调试功能
│   └── movement_table.h    # 动作组轨迹表（自动生成）
├── include/                 # 头文件目录
│   ├── config.h            # 配置参数（运动学参数、速度等）
│   ├── PinDefines.h        # 引脚定义
│   ├── controller_index.h  # Web控制页面HTML（压缩）
│   └── calibration_index.h # 校准页面HTML（压缩）
├── lib/                     # 第三方库目录
│   ├── ArduinoJson/         # JSON处理库
│   ├── ESPAsyncWebServer/  # Web服务器库
│   └── hal/                # 硬件抽象层（PWM驱动）
├── data/                    # SPIFFS文件系统数据
│   └── text.txt            # 启动欢迎信息
└── scripts/                 # 构建脚本
    └── release.py          # 发布脚本
```

##  4.2.2 核心模块介绍

**1. 主程序模块（main.cpp）**
- 系统初始化：WiFi、SPIFFS、I2C、串口
- Web服务器和WebSocket服务
- FreeRTOS任务管理：
  - 电池监测任务（BatteryMonitorTask）
  - LED控制任务（LEDControllerTask）
  - 串口指令处理任务（SerialCommandTask）
- 主循环：运动模式循环和校准模式循环

**2. 六足控制模块（hexapod.h/cpp）**
- `HexapodClass`：六足机器人的核心控制类
- 管理6条腿的实例
- 运动处理接口
- 速度控制接口
- 校准数据管理（保存/加载）

**3. 腿部控制模块（leg.h/cpp）**
- `Leg`：单条腿的控制类
- 正运动学和逆运动学计算
- 世界坐标系与局部坐标系转换
- 足端位置控制

**4. 动作控制模块（movement.h/cpp, movements.cpp）**
- `Movement`：动作执行类
- 动作组切换和插值过渡
- 速度控制
- 动作表管理

**5. 舵机控制模块（servo.h/cpp）**
- `Servo`：单个舵机的控制类
- 角度设置（-60°~60°）
- 校准偏移量管理
- PCA9685 PWM驱动接口

**6. 基础数据结构（base.h）**
- `Point3D`：三维点结构
- `Locations`：六条腿的足端位置集合

**7. 通信模块**
- WebSocket：实时控制指令接收
- HTTP：页面服务和校准接口
- 串口（UART2）：运动指令接收

#  4.3 主要类与接口

##  4.3.1 HexapodClass（六足主类）

**定义位置：** `src/hexapod.h`

**核心成员变量：**
```cpp
MovementMode mode_;           // 当前运动模式
Movement movement_;           // 动作执行器
Leg legs_[6];                 // 六条腿实例
```

**主要接口：**

**初始化：**
```cpp
void init(bool setting, bool isReset=false);
```
- `setting`：是否为校准模式
- `isReset`：是否重置校准数据

**运动控制：**
```cpp
void processMovement(MovementMode mode, int elapsed = 0);
```
- 处理运动模式，每帧调用一次
- `mode`：运动模式枚举
- `elapsed`：距上次调用的时间（毫秒）

**速度控制：**
```cpp
void setMovementSpeed(float speed);              // 设置速度倍数（0.25-1.0）
void setMovementSpeedLevel(SpeedLevel level);    // 设置速度等级
float getMovementSpeed() const;                  // 获取当前速度
```

**校准接口：**
```cpp
void calibrationSave();                                    // 保存校准数据到Flash
void calibrationGet(int legIndex, int partIndex, int& offset);
void calibrationSet(int legIndex, int partIndex, int offset);
void calibrationSet(CalibrationData& calibrationData);
void calibrationTest(int legIndex, int partIndex, float angle);
void calibrationTestAllLeg(float angle);
void clearOffset();                                       // 清除所有偏移
void forceResetAllLegTippos();                           // 强制重置所有足端位置
```

**全局实例：**
```cpp
extern HexapodClass Hexapod;  // 全局六足实例
```

##  4.3.2 Leg（腿部类）

**定义位置：** `src/leg.h`

**核心功能：**
- 运动学计算（正运动学、逆运动学）
- 坐标系转换（世界坐标系 ↔ 局部坐标系）
- 足端位置控制

**主要接口：**

**坐标转换：**
```cpp
void translateToLocal(const Point3D& world, Point3D& local);
void translateToWorld(const Point3D& local, Point3D& world);
```

**足端控制：**
```cpp
void moveTip(const Point3D& to);                    // 世界坐标系
void moveTipLocal(const Point3D& to);                // 局部坐标系
const Point3D& getTipPosition(void);                 // 获取世界坐标
const Point3D& getTipPositionLocal(void);            // 获取局部坐标
```

**关节控制：**
```cpp
void setJointAngle(float angle[3]);                  // 直接设置三个关节角度
```

**舵机访问：**
```cpp
Servo* get(int partIndex);                           // 获取指定关节的舵机对象
```

**内部实现：**
- 每个 `Leg` 实例管理3个 `Servo` 对象（对应3个关节）
- 维护腿的安装位置和坐标转换函数
- 跟踪当前足端位置

##  4.3.3 Movement（动作类）

**定义位置：** `src/movement.h`

**运动模式枚举：**
```cpp
enum MovementMode {
    MOVEMENT_STANDBY = 0,      // 待机
    MOVEMENT_FORWARD,          // 前进
    MOVEMENT_FORWARDFAST,      // 快速前进
    MOVEMENT_BACKWARD,         // 后退
    MOVEMENT_TURNLEFT,         // 左转
    MOVEMENT_TURNRIGHT,        // 右转
    MOVEMENT_SHIFTLEFT,        // 左移
    MOVEMENT_SHIFTRIGHT,       // 右移
    MOVEMENT_CLIMB,            // 攀爬
    MOVEMENT_ROTATEX,          // X轴旋转
    MOVEMENT_ROTATEY,          // Y轴旋转
    MOVEMENT_ROTATEZ,          // Z轴旋转
    MOVEMENT_TWIST,            // 扭转
    MOVEMENT_TOTAL,            // 总数（用于边界检查）
};
```

**动作表结构：**
```cpp
struct MovementTable {
    const Locations* table;    // 轨迹点数组
    int length;                // 轨迹点数量
    int stepDuration;         // 每步持续时间（毫秒）
    const int* entries;       // 步态入口索引数组
    int entriesCount;         // 入口数量
};
```

**主要接口：**

**模式设置：**
```cpp
Movement(MovementMode mode);           // 构造函数
void setMode(MovementMode newMode);    // 切换模式
```

**动作执行：**
```cpp
const Locations& next(int elapsed);     // 获取下一帧的足端位置
```

**速度控制：**
```cpp
void setSpeed(float speed);            // 设置速度倍数（0.25-1.0）
float getSpeed() const;                // 获取当前速度
```

**工作原理：**
1. 根据当前模式查找对应的 `MovementTable`
2. 根据时间步进轨迹表索引
3. 在模式切换时进行平滑过渡插值
4. 根据速度参数调整步进速度

##  4.3.4 Servo（舵机类）

**定义位置：** `src/servo.h`

**核心功能：**
- 舵机角度控制（-60°~60°）
- 校准偏移量管理
- PCA9685 PWM驱动

**主要接口：**

**静态初始化：**
```cpp
static void init(void);                // 初始化PCA9685驱动板
```

**角度控制：**
```cpp
void setAngle(float angle);            // 设置角度（-60°~60°）
float getAngle(void);                  // 获取当前角度
```

**校准参数：**
```cpp
void getParameter(int& offset);        // 获取偏移量
void setParameter(int offset, bool update = true);  // 设置偏移量
```

**内部实现：**
- 每个舵机对应PCA9685的一个PWM通道
- 支持方向反转（`inverse_`）
- 支持角度范围限制（`range_`）
- 偏移量直接调整PWM脉宽

#  4.4 轨迹生成工具（pathTool）

##  4.4.1 工具简介

`pathTool` 是一个Python工具，用于生成六足机器人的足端轨迹表。它位于 `reference/pathTool/` 目录下。

**主要功能：**
- 根据预定义的路径生成函数，计算足端轨迹点
- 验证轨迹点是否在安全角度范围内
- 生成C++格式的动作表头文件（`movement_table.h`）

**工具结构：**
```
pathTool/
├── src/
│   ├── main.py            # 主程序入口
│   ├── config.py          # 运动学参数配置
│   ├── kinematics.py      # 逆运动学计算
│   ├── path/              # 路径生成脚本目录
│   │   ├── forward.py     # 前进轨迹
│   │   ├── backward.py    # 后退轨迹
│   │   ├── turnleft.py     # 左转轨迹
│   │   ├── turnright.py    # 右转轨迹
│   │   ├── shiftleft.py   # 左移轨迹
│   │   ├── shiftright.py  # 右移轨迹
│   │   ├── climb.py        # 攀爬轨迹
│   │   ├── rotatex.py       # X轴旋转轨迹
│   │   ├── rotatey.py      # Y轴旋转轨迹
│   │   ├── rotatez.py      # Z轴旋转轨迹
│   │   ├── twist.py        # 扭转轨迹
│   │   └── lib.py          # 路径生成工具函数
│   └── output/
│       └── movement_table.h  # 生成的轨迹表文件
└── fabfile.py
```

**路径生成脚本接口：**
每个路径脚本需要实现 `path_generator()` 函数，返回：
- `data`：轨迹数据（shift模式或matrix模式）
- `mode`：生成模式（"shift" 或 "matrix"）
- `dur`：每步持续时间（毫秒）
- `entries`：步态入口索引列表

##  4.4.2 使用方法

**基本用法：**
```bash
cd reference/pathTool/src
python main.py
```

**可选参数：**
```bash
python main.py --pathDir path --outPath output/movement_table.h
```
- `--pathDir`：路径脚本目录（默认：`path`）
- `--outPath`：输出文件路径（默认：`output/movement_table.h`）

**工作流程：**
1. 扫描 `path/` 目录下的所有 `.py` 文件
2. 加载每个文件的 `path_generator` 函数
3. 调用生成函数获取轨迹数据
4. 验证所有轨迹点是否在安全角度范围内
5. 生成C++格式的动作表头文件

**验证机制：**
- 使用逆运动学计算每个轨迹点的关节角度
- 检查角度是否在限制范围内（`angleLimitation`）
- 如果验证失败，程序会报错并退出

##  4.4.3 轨迹文件格式

生成的 `movement_table.h` 文件包含以下内容：

**1. 轨迹点数组：**
```cpp
const Locations forward_paths[] {
    {{P1X+(0.00), P1Y+(0.00), P1Z+(25.00)}, {P2X+(0.00), P2Y+(0.00), P2Z+(0.00)}, ...},
    {{P1X+(0.00), P1Y+(7.73), P1Z+(23.78)}, {P2X+(0.00), P2Y+(-5.00), P2Z+(0.00)}, ...},
    // ... 更多轨迹点
};
```

**说明：**
- `P1X`, `P1Y`, `P1Z` 等是预定义的基准位置宏（在 `movements.cpp` 中定义）
- 括号内的数值是相对于基准位置的偏移量
- 每个 `Locations` 包含6条腿的足端位置

**2. 步态入口索引：**
```cpp
const int forward_entries[] { 0, 10 };
```

**说明：**
- 定义步态的起始点索引
- 例如 `{0, 10}` 表示两个步态组，分别从索引0和10开始

**3. 动作表定义：**
```cpp
const MovementTable forward_table {
    forward_paths,    // 轨迹点数组
    20,               // 轨迹点数量
    20,               // 每步持续时间（毫秒）
    forward_entries,  // 入口索引数组
    2                // 入口数量
};
```

**4. 访问函数：**
```cpp
const MovementTable& forwardTable() {
    return forward_table;
}
```

**集成到固件：**
生成的 `movement_table.h` 需要被 `movements.cpp` 包含，并通过 `movements.cpp` 中的映射函数关联到对应的 `MovementMode`。

---
